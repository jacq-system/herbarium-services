{% extends 'base.html.twig' %}
{% block title %}RESTS service checkpoint{% endblock %}

{% block body %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const items = Array.from(document.querySelectorAll('.item'));
            const concurrency = 3;
            const timeoutMs = 200 * 1000;
            let running = 0;
            let index = 0;

            function next() {
                while (running < concurrency && index < items.length) {
                    const item = items[index++];
                    const url = item.getAttribute('data-url');
                    const badge = item.querySelector('.badge');
                    const para = item.querySelector('p');
                    const h5 = item.querySelector('h5');

                    running++;

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                    fetch(url, { signal: controller.signal })
                        .then(response => {
                            clearTimeout(timeoutId);
                            badge.textContent = response.status;

                            h5.classList.remove('bg-success', 'bg-error', 'bg-primary');
                            if (response.status === 200) {
                                h5.classList.add('bg-success');
                            } else if (response.status === 404) {
                                h5.classList.add('bg-error');
                            } else {
                                h5.classList.add('bg-primary');
                            }

                            return response.text();
                        })
                        .then(body => {
                            para.textContent = body;
                        })
                        .catch(err => {
                            clearTimeout(timeoutId);
                            badge.textContent = 'ERR';
                            para.textContent = err.name === 'AbortError' ? 'Timeout after ' + timeoutMs/1000 + 's' : err.message;

                            h5.classList.remove('bg-success', 'bg-error', 'bg-primary');
                            h5.classList.add('bg-error');
                        })
                        .finally(() => {
                            running--;
                            next();
                        });
                }
            }

            next();
        });
    </script>


    <div class="container-fluid">
        <h3>REST test</h3>
        <p>testing API of JACQ.org and the Symfony clone using example values in OpenApi definition (of the Symfony <a
                href="https://github.com/jacq-system/symfony">repository</a>)</p>

        {% for path, domain in results %}
            <div class="row">
                <h5>{{ path }}</h5>

                {% for server, url in domain %}
                    <div class="col-6 item" data-url="{{ url }}">
                        <h5>{{ server }} <span class="badge"></span></h5>
                        <a href="{{ url }}">{{ url }}</a>
                        <p>- - waiting - -</p>
                    </div>
                {% endfor %}

            </div>
        {% endfor %}
    </div>

{% endblock %}
